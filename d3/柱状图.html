<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>D3 Bar Chart – Import CSV then Render</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    svg {
      border: 1px solid #ccc;
      background: #f9f9f9;
      display: block;
      margin: 12px auto;
    }
    .controls {
      text-align: center;
      margin-top: 16px;
    }
    .hint { color: #666; font-size: 14px; }
  </style>
</head>
<body>

  <div class="controls">
    <input type="file" id="file" accept=".csv" />
    <div class="hint">请选择一个 CSV 文件（需要包含列：<code>platform</code>、<code>globalsale</code>）。</div>
  </div>

  <svg id="mainsvg" width="100%" height="1080"></svg>

  <script>
    const svg = d3.select('#mainsvg');

    // ⚠️ 宽度用 getBoundingClientRect（width="100%" 时，attr("width") 返回 "100%"，会导致 NaN）
    function getSize() {
      const width = svg.node().getBoundingClientRect().width;
      const height = +svg.attr('height'); // 高度是明确像素，直接转数字
      return { width, height };
    }

    const margin = { top: 60, right: 30, bottom: 60, left: 120 };

    // 比例尺与主分组（每次绘图前清空再重建）
    function render(data) {
      // 类型转换与清洗
      data = data.map(d => ({
        platform: d.platform,
        globalsale: +d.globalsale
      })).filter(d => d.platform != null && !Number.isNaN(d.globalsale));

      // 清空旧图
      svg.selectAll('*').remove();

      const { width, height } = getSize();
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

      const xScale = d3.scaleLinear()
        .domain([0, d3.max(data, d => d.globalsale) || 0]) // 防空数据
        .nice()
        .range([0, innerWidth]);

      const yScale = d3.scaleBand()
        .domain(data.map(d => d.platform))
        .range([0, innerHeight])
        .padding(0.1);

      // 条形
      g.selectAll('rect')
        .data(data)
        .join('rect')
        .attr('x', 0)
        .attr('y', d => yScale(d.platform))
        .attr('width', d => xScale(d.globalsale))
        .attr('height', yScale.bandwidth())
        .attr('fill', 'steelblue');

      // 轴
      const xAxis = d3.axisBottom(xScale).ticks(10);
      const yAxis = d3.axisLeft(yScale);

      g.append('g')
        .attr('transform', `translate(0,${innerHeight})`)
        .call(xAxis)
        .call(g => g.selectAll('.tick text').attr('font-size', '12px'));

      g.append('g')
        .call(yAxis)
        .call(g => g.selectAll('.tick text').attr('font-size', '12px'));

      // 轴标题
      g.append('text')
        .attr('x', innerWidth / 2)
        .attr('y', innerHeight + 40)
        .attr('text-anchor', 'middle')
        .attr('fill', 'black')
        .text('globalsale');

      g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -innerHeight / 2)
        .attr('y', -80)
        .attr('text-anchor', 'middle')
        .attr('fill', 'black')
        .text('platform');

      // 标题
      svg.append('text')
        .attr('x', width / 2)
        .attr('y', 28)
        .attr('text-anchor', 'middle')
        .attr('font-size', '20px')
        .text('Platform Global Sales');
    }

    // 文件选择 → 读取 → 解析 → 渲染
    document.getElementById('file').addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result;
          const data = d3.csvParse(text); // 解析 CSV 文本为对象数组
          // 简单检查列是否存在
          if (!data.columns || !data.columns.includes('platform') || !data.columns.includes('globalsale')) {
            alert('CSV 需要包含列：platform, globalsale');
            return;
          }
          render(data);
        } catch (err) {
          console.error(err);
          alert('解析 CSV 失败，请检查文件格式。');
        }
      };
      reader.readAsText(file, 'utf-8');
    });


    // 可选：窗口大小变化时重绘（已导入过数据才重绘）
    let lastData = null;
    const originalRender = render;
    render = function(data) { lastData = data; originalRender(data); };
    window.addEventListener('resize', () => { if (lastData) originalRender(lastData); });
  </script>
</body>
</html>
